{"title":"Scraping paginated HTML sites in R","markdown":{"yaml":{"title":"Scraping paginated HTML sites in R","author":"Jonathan","date":"09-19-2022","description":"Showcasing web scraping in R with a focus on historical Swedish data","image":"https://raw.githubusercontent.com/j-jayes/screencasts/main/images/tax.jpg","format":{"html":{"code-link":true,"code-overflow":"wrap"}},"draft":true,"execute":{"freeze":true,"eval":false}},"headingText":"Purpose","containsRefs":false,"markdown":"\n\nScrape the website of the Stockholm city archive.\n\n## Structure of the screencast\n\n### Look at the webpage\n\n- View page source\n\n### Check permission\n\n- Robots.txt file\n\n```{r}\nlibrary(robotstxt)\nget_robotstxt(\"https://sok.stadsarkivet.stockholm.se/\")\n```\n\n\n### Function to get the table elements\n\n- Using `rvest` to get the table elements\n\n```{r}\nlibrary(rvest)\nlibrary(tidyverse)\n\nurl <- \"https://sok.stadsarkivet.stockholm.se/Databas/mantalsregister-1800-1884/Sok?sidindex=0&artal=1800\"\n\nget_table_data <- function(url) {\n  message(\"Getting data from \", url)\n  html <- read_html(url)\n\n  table <- html %>%\n    html_nodes(\".table\") %>%\n    html_table()\n\n  table <- table[[1]]\n\n  table <- table %>%\n    filter(between(row_number(), 4, 13)) %>%\n    select(1:7) %>%\n    rename(\n      year = X1,\n      district = X2,\n      index = X3,\n      surname = X4,\n      first_name = X5,\n      title = X6,\n      other = X7\n    )\n  \n  table\n}\n\n# test\nget_table_data(url)\n```\n\n\n### Get the number of pages on which there is data\n\n- Write a neat little function for this\n```{r}\nget_n_pages <- function(url) {\n  html <- read_html(url)\n  message(\"Getting the number of pages from \", url)\n\n  n_res <- html %>%\n    html_nodes(\".antaltraffar-div\") %>%\n    html_text() %>%\n    str_squish() %>%\n    str_extract(\"[0-9].*\") %>%\n    str_remove(., \" \") %>%\n    parse_number()\n\n  n_pages <- ceiling(n_res / 10)\n\n  n_pages\n}\n\n# test\nget_n_pages(url)\n\n```\n\n\n### Create a workflow to go through\n\n- Include parameters that we can change\n```{r}\nyear_search <- 1800\nbase_url <- paste0(\"https://sok.stadsarkivet.stockholm.se/Databas/mantalsregister-1800-1884/Sok?sidindex=0&artal=\", year_search)\nstart_page <- 1\nfinal_page <- get_n_pages(base_url)\n\nlist_of_pages <- tibble(\n  url = paste0(\"https://sok.stadsarkivet.stockholm.se/Databas/mantalsregister-1800-1884/Sok?sidindex=\", start_page:final_page, \"&artal=\", year_search),\n  page = start_page:final_page\n)\n```\n\n\n### Iterate through the list of pages\n\n- Using the map function\n```{r}\ndf_out <- list_of_pages %>% \n  head(10) %>% \n  mutate(data = map(url, possibly(get_table_data, \"failed\"))) %>% \n  select(!url)\n\ndf_out <- df_out %>% \n  unnest(data)\n```\n\n\n### Save the data to a csv file\n\n- Some data management\n```{r}\ntime <- Sys.time()\n```\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":false,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"Mantalsregister_scraper.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.237","editor":"source","theme":{"light":["cosmo","../theme.scss"]},"title":"Scraping paginated HTML sites in R","author":"Jonathan","date":"09-19-2022","description":"Showcasing web scraping in R with a focus on historical Swedish data","image":"https://raw.githubusercontent.com/j-jayes/screencasts/main/images/tax.jpg","draft":true},"extensions":{"book":{"multiFile":true}}}}}