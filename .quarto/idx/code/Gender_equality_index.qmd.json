{"title":"Gender Equality Index in the EU","markdown":{"yaml":{"title":"Gender Equality Index in the EU","author":"Jonathan","date":"08-20-2022","description":"Using `ggiraph` to recreate an interactive visualization from *The Economist*.","image":"https://raw.githubusercontent.com/j-jayes/screencasts/main/images/economist_glass_ceiling_index.PNG","format":{"html":{"code-link":true,"code-overflow":"wrap"}},"draft":false,"execute":{"freeze":false}},"headingText":"Exploring Gender Equality in the EU","containsRefs":false,"markdown":"\n\n\n## Purpose\n\nShow a workflow in creating an interactive figure and highlight some data munging tips.\n\nFocus is on:\n\n- Getting data from excel into R with some nice functions etc.\n- Interactive charts\n- Data viz\n\n## Intro\n\nData from [landing page](https://eige.europa.eu/gender-equality-index/2021) and you can download the excel sheet [here](https://eige.europa.eu/sites/all/modules/custom/eige_gei/app/content/downloads/gender-equality-index-2013-2015-2017-2019-2020-2021.xlsx).\n\nThere are more than 140 indicators that fall into 6 domains and 14 sub-domains.\n\n## Description of data ingestion\n\nThe data comes in a common format -- there is an excel workbook with a readme sheet, then a metadata sheet describing the different variables, then a sheet for the years 2010, 2012, 2015, 2017, 2018 and 2019.\n\nWe can make a simple plot of the index changes over time, in relative terms and in absolute terms.\n\n## Ingest\n\n### Readme sheet\n\n```{r}\nlibrary(tidyverse)\nlibrary(here)\ntheme_set(theme_light())\ndf <- readxl::read_excel(here(\"data/Gender-equality-index.xlsx\"))\n\ndf %>% \n  knitr::kable()\n```\n\n### Codebook\n\nThe problem is that this is written in a silly way - it's readable to humans but not to computers\n\n```{r}\n# df <- readxl::read_excel(here(\"data/Gender-equality-index.xlsx\"), sheet = 2, range = )\n```\n\n\n### Data read in process\n\nWhat we want to do is take the wide dataset from the year tabs and then make them long so that we can collect them together and draw some functions over time.\n\nI should make a graphic of how we go from colours having meaning to columns containing this kind of information. Like a panel on the left where we have a screenshot of the excel sheet - then an arrow - then on the right we have a nice simple grouped dataset on the right.\n\n```{r, eval=F}\nsheets <- tibble(\n  sheet = 3:8,\n  year = c(2010, 2012, 2015, 2017, 2018, 2019)\n)\n\nget_data <- function(sh) {\n  message(\"Getting data from \", sh)\n\n  df <- readxl::read_excel(here(\"data/Gender-equality-index.xlsx\"), sheet = sh)\n\n  df <- df %>%\n    janitor::clean_names() %>%\n    pivot_longer(-c(index_year:gender_equality_index))\n\n  df\n}\n\nsheets <- sheets %>%\n  mutate(data = map(sheet, possibly(get_data, \"failed\")))\n\ndf <- sheets %>%\n  unnest(data)\n```\n\n### Data augmentation\n\n#### Country names\n\nWe might want to get the English names of a country\n\n```{r, eval=F}\ndf %>% \n  count(country)\n```\n\nWe can use the `countrycode` package:\n\n```{r, eval=F}\nlibrary(countrycode)\n\ncountries <- df %>% \n  distinct(country)\n\ncountries <- countries %>% \n  mutate(country_name = countrycode(country, \"iso2c\", \"country.name\")) %>% \n  mutate(country_name = case_when(\n    country == \"EU\" ~ \"European Union\",\n    country == \"EL\" ~ \"Greece\",\n    TRUE ~ country_name\n    \n    \n  ))\n\ndf <- df %>% \n  inner_join(countries)\n```\n\n#### GDP per capita by year\n\nData from Eurostat:\n\n<blockquote>\n\nThe indicator is calculated as the ratio of real GDP to the average population of a specific year. GDP measures the value of total final output of goods and services produced by an economy within a certain period of time. It includes goods and services that have markets (or which could have markets) and products which are produced by general government and non-profit institutions. It is a measure of economic activity and is also used as a proxy for the development in a countryâ€™s material living standards. However, it is a limited measure of economic welfare. For example, neither does GDP include most unpaid household work nor does GDP take account of negative effects of economic activity, like environmental degradation.\n\n</blockquote>\n\n```{r}\ngdp_pc <- readxl::read_excel(here(\"data/Gender-equality-index_augment_with_gdp_pc.xlsx\"), sheet = 3, range = \"A9:AS49\")\n\ncols <- 2*1:22\n\ngdp_pc <- gdp_pc %>% \n  select(1, cols) %>% \n  mutate(across(-TIME, as.numeric)) %>% \n  pivot_longer(-TIME) %>% \n  rename(country_name = TIME) %>% \n  filter(country_name != \"GEO (Labels)\") %>% \n  mutate(name = parse_number(name)) %>% \n  rename(year = name)\n```\n\nInteractive\n\n```{r}\nlibrary(ggiraph)\n\nf <- gdp_pc %>%\n  mutate(\n    value_chr = scales::dollar(value),\n    tooltip = paste0(country_name, \"\\n\", value_chr, \"\\n\", year)\n  ) %>%\n  ggplot(aes(x = year, y = value, \n             colour = country_name,\n             group = country_name)) +\n  geom_point_interactive(aes(tooltip = tooltip), cex = 2) +\n  geom_line_interactive() +\n  scale_y_continuous(labels = scales::dollar_format()) +\n  theme(legend.position = \"none\") +\n  labs(\n    x = NULL,\n    y = \"GDP per capita \",\n    caption = \"Data from Eurostat\"\n  )\n\nggiraph(ggobj = f) %>%\n  girafe_options(\n    opts_hover(css = girafe_css(\n      css = \"fill:none;stroke:red;r:5pt;\",\n      point = \"fill:black;stroke:none;\"\n    )),\n    opts_hover_inv(css = girafe_css(\n      css = \"fill:none;stroke:gray;opacity:.9\",\n      text = \"fill:gray;stroke:none;opacity:.9\"\n    ))\n  )\n\n```\n\n## In prep read in data here\n\n```{r}\ndf <- read_rds(here(\"data/Gender-equality-index.rds\"))\n```\n\n\n\n```{r}\ndf %>% \n  ggplot(aes(index_year, gender_equality_index, colour = country_name)) +\n  geom_line()\n```\n\nHow can we make the countries more clear?\n\n`gghighlight`\n\n```{r}\ncountries_highlight <- df %>% \n  distinct(country_name) %>% \n  sample_n(6) %>% \n  pull()\n\ndf %>%\n  mutate(flag = case_when(\n    country_name %in% countries_highlight ~ 1,\n    TRUE ~ 0\n  )) %>%\n  ggplot(aes(index_year, gender_equality_index, colour = country_name)) +\n  geom_line(size = 3) +\n  gghighlight::gghighlight(flag == 1) +\n  scale_x_continuous(labels = scales::number_format(accuracy = 1, big.mark = \"\")) +\n  scale_y_continuous(labels = scales::percent_format(scale = 1))\n\n```\n\n\nRecreate a nice ranking change?\n\n```{r}\ndf_rank <- df %>%\n  select(reference_year_main, country_name, gender_equality_index) %>%\n  distinct()\n\ndf_rank <- df_rank %>%\n  group_by(reference_year_main) %>%\n  mutate(rank = rank(desc(gender_equality_index), ties.method = \"average\")) %>%\n  ungroup() %>%\n  rename(year = reference_year_main)\n\ndf_rank %>%\n  ggplot(aes(year, rank, color = country_name)) +\n  geom_line(size = 3)\n```\n\nWhat elements do we need?\n\n- Labels on left and right that include rank and country name\n- Colour scale that goes from blue to red based on ranking at end of period\n- Interactivity with ggiraph probably.\n\nIs there a better way to do this?\n\n```{r}\nlabels_left <- df_rank %>% \n  filter(year == min(year)) %>% \n  mutate(left_rank = rank) %>% \n  select(country_name, left_rank)\n\nlabels_right <- df_rank %>% \n  filter(year == max(year)) %>% \n  mutate(right_rank = rank) %>% \n  select(country_name, right_rank)\n\ndf_rank <- df_rank %>% \n  inner_join(labels_left) %>% \n  inner_join(labels_right)\n```\n\n\n```{r}\ndf_rank %>%\n  ggplot(aes(year, rank, color = right_rank, group = country_name)) +\n  geom_line(size = 2.8, aes(year, rank, group = country_name), colour = \"black\") +\n  geom_line(size = 2) +\n  geom_text(aes(\n    x = 2010, y = left_rank,\n    label = paste0(left_rank, \". \", country_name)\n  ),\n  colour = \"black\",\n  hjust = 1.1,\n  cex = 3\n  ) +\n  geom_text(aes(\n    x = 2019, y = right_rank,\n    label = paste0(right_rank, \". \", country_name)\n  ),\n  colour = \"black\",\n  hjust = 0,\n  cex = 3\n  ) +\n  scale_y_reverse() +\n  scale_color_gradient2(\n    low = \"blue\", high = \"red\",\n    mid = \"pink\",\n    midpoint = 12\n  ) +\n  scale_x_continuous(breaks = c(2010, 2012, 2015, 2017, 2018, 2019)) +\n  coord_cartesian(xlim = c(2009, 2020)) +\n  theme(\n    legend.position = \"none\",\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.text.y = element_blank()\n  ) +\n  labs(\n    x = NULL,\n    y = NULL\n  ) \n```\n\nInteractivity\n\n```{r}\nlibrary(ggiraph)\n\ng <- df_rank %>%\n  ggplot(aes(year, rank, color = right_rank, group = country_name, tooltip = country_name)) +\n  geom_line(size = 2.8, aes(year, rank, group = country_name), colour = \"black\") +\n  geom_line_interactive(size = 2, aes(data_id = country_name)) +\n  geom_text_interactive(aes(\n    x = 2010, y = left_rank,\n    label = paste0(left_rank, \". \", country_name),\n    data_id = country_name\n  ),\n  colour = \"black\", hjust = 1.1, cex = 3\n  ) +\n  geom_text_interactive(aes(\n    x = 2019, y = right_rank,\n    label = paste0(right_rank, \". \", country_name),\n    data_id = country_name\n  ),\n  colour = \"black\", hjust = 0, cex = 3\n  ) +\n  scale_y_reverse() +\n  scale_color_gradient2(\n    low = \"blue\", high = \"red\", mid = \"pink\",\n    midpoint = 14\n  ) +\n  scale_x_continuous(breaks = c(2010, 2012, 2015, 2017, 2018, 2019)) +\n  coord_cartesian(xlim = c(2008, 2021)) +\n  theme(\n    legend.position = \"none\",\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.text.y = element_blank()\n  ) +\n  labs(\n    x = NULL,\n    y = NULL\n  )\n```\n\n\n```{r}\nggiraph(ggobj = g) %>%\n  girafe_options(\n    opts_hover(css = girafe_css(\n      css = \"fill:none;stroke:red;r:5pt;\",\n      text = \"fill:black;stroke:none;\"\n    )),\n    opts_hover_inv(css = girafe_css(\n      css = \"fill:none;stroke:gray;opacity:.9\",\n      text = \"fill:gray;stroke:none;opacity:.9\"\n    ))\n  )\n```\n\nYay! It works! Have a look at Hungary falling right to the bottom.\n\nGreat. I hope that was useful. \n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"Gender_equality_index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.237","editor":"source","theme":{"light":["cosmo","../theme.scss"]},"title":"Gender Equality Index in the EU","author":"Jonathan","date":"08-20-2022","description":"Using `ggiraph` to recreate an interactive visualization from *The Economist*.","image":"https://raw.githubusercontent.com/j-jayes/screencasts/main/images/economist_glass_ceiling_index.PNG","draft":false},"extensions":{"book":{"multiFile":true}}}}}